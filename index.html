<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MediFiles — Secure Medical Reports</title>

  <!-- Google font & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1720; --card:#0b1220; --muted:#98a0b3; --accent:#6c8cff; --glass: rgba(255,255,255,0.04);
      --success:#22c55e; --danger:#ef4444;
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; background:linear-gradient(180deg,#071023 0%, #0b1320 60%);
      color:#e6eef8; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      padding:28px;
    }

    .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:300px 1fr;gap:24px;}
    .panel{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:14px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#9ad0ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021029}
    h1{font-size:20px;margin:0}
    p.muted{color:var(--muted);margin:6px 0 0;font-size:13px}

    /* Left sidebar: auth & profile */
    .sidebar .section{margin-bottom:18px}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type="text"], input[type="email"], input[type="password"], select, textarea{
      width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);
      color:inherit;font-size:14px;outline:none
    }
    button{cursor:pointer;padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:#021029;font-weight:600}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    small.help{color:var(--muted);display:block;margin-top:6px}

    /* Right main */
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .search{display:flex;gap:12px;align-items:center}
    .cards{display:flex;gap:12px}
    .info-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:12px;border-radius:10px;min-width:120px}
    .file-list{margin-top:12px}
    .file-row{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent);margin-bottom:8px}
    .file-meta{flex:1}
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px;color:var(--muted)}

    .actions{display:flex;gap:8px}
    .actions button{padding:8px 10px;border-radius:8px;font-weight:600}

    /* preview modal */
    .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.8));z-index:9999}
    .modal.open{display:flex}
    .modal .card{width:90%;max-width:900px;height:80%;background:#071226;border-radius:12px;padding:12px;display:flex;flex-direction:column}
    .modal iframe, .modal img{flex:1;border-radius:8px;width:100%;height:100%;object-fit:contain;background:#081021}

    /* responsive */
    @media (max-width:900px){ .wrap{grid-template-columns: 1fr} .sidebar{order:2} .panel{padding:12px} }
    .note{font-size:13px;color:var(--muted);margin-top:8px}
    .error{color:var(--danger);font-size:13px;margin-top:6px}
    .success{color:var(--success);font-size:13px;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- SIDEBAR: Auth & Profile -->
    <div class="panel sidebar">
      <div class="brand">
        <div class="logo">MF</div>
        <div>
          <h1>MediFiles</h1>
          <p class="muted">Secure medical report storage</p>
        </div>
      </div>

      <div id="authArea" class="section">
        <h3 style="margin:0 0 8px 0">Sign In / Register</h3>

        <label>Email</label>
        <input id="email" type="email" placeholder="you@hospital.com" />

        <label>Password</label>
        <input id="password" type="password" placeholder="Enter password" />

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="signInBtn">Sign in</button>
          <button id="registerBtn" class="ghost">Register</button>
        </div>

        <div id="authMsg" class="note"></div>
      </div>

      <div id="profileArea" class="section" style="display:none">
        <h3 style="margin:0 0 8px 0">Profile</h3>
        <label>Full name</label>
        <input id="displayName" type="text" placeholder="Your name" />
        <label>Phone (optional)</label>
        <input id="phone" type="text" placeholder="+91..." />
        <label>About</label>
        <textarea id="about" rows="3" placeholder="Short bio / patient info"></textarea>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="saveProfileBtn">Save Profile</button>
          <button id="signOutBtn" class="ghost">Sign out</button>
        </div>

        <div id="profileMsg" class="note"></div>
      </div>

      <div class="section">
        <h4 style="margin:0 0 6px 0">Storage Info</h4>
        <div class="note">Files are stored securely in Firebase Storage. Use strong passwords and enable 2FA in your Firebase settings.</div>
      </div>
    </div>

    <!-- MAIN: Upload, list -->
    <div class="panel main">
      <div class="topbar">
        <div>
          <h2 style="margin:0">My Reports</h2>
          <p class="muted">Upload, preview, share and manage medical reports.</p>
        </div>
        <div class="search">
          <input id="searchBox" placeholder="Search by name or tag" style="padding:10px;border-radius:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);outline:none" />
          <button id="refreshBtn" class="ghost">Refresh</button>
        </div>
      </div>

      <!-- upload -->
      <div style="display:flex;gap:12px;align-items:center">
        <input id="fileInput" type="file" />
        <input id="docName" type="text" placeholder="Report name (e.g., MRI Scan - Brain)" style="width:280px" />
        <input id="docTag" type="text" placeholder="Tag (e.g., Imaging / Lab / Consultation)" style="width:220px" />
        <button id="uploadBtn">Upload</button>
      </div>
      <small class="help">Allowed: PDFs, images, common docs. Max file size depends on your Firebase plan.</small>
      <div id="uploadMsg" class="note"></div>

      <!-- files list -->
      <div class="file-list" id="fileList"></div>

    </div>
  </div>

  <!-- Modal preview -->
  <div id="previewModal" class="modal" aria-hidden="true">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div id="previewTitle"></div>
        <div style="display:flex;gap:8px">
          <button id="closePreview" class="ghost">Close</button>
        </div>
      </div>
      <div id="previewBody" style="flex:1"></div>
    </div>
  </div>

  <!-- Firebase SDK (modular v9) -->
  <script type="module">
    // --------- CONFIG: Paste your Firebase config here ----------
    // Create a Firebase project and enable:
    // - Authentication (Email/Password)
    // - Firestore (native mode)
    // - Storage
    // Then paste the config object below.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.30.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.30.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, getDocs, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.30.0/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.30.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "REPLACE_ME",
      authDomain: "REPLACE_ME",
      projectId: "REPLACE_ME",
      storageBucket: "REPLACE_ME",
      messagingSenderId: "REPLACE_ME",
      appId: "REPLACE_ME"
    };
    // -----------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // UI refs
    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    const signInBtn = document.getElementById('signInBtn');
    const registerBtn = document.getElementById('registerBtn');
    const authMsg = document.getElementById('authMsg');

    const profileArea = document.getElementById('profileArea');
    const displayNameEl = document.getElementById('displayName');
    const phoneEl = document.getElementById('phone');
    const aboutEl = document.getElementById('about');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const profileMsg = document.getElementById('profileMsg');
    const signOutBtn = document.getElementById('signOutBtn');

    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const docNameEl = document.getElementById('docName');
    const docTagEl = document.getElementById('docTag');
    const uploadMsg = document.getElementById('uploadMsg');
    const fileListEl = document.getElementById('fileList');
    const refreshBtn = document.getElementById('refreshBtn');
    const searchBox = document.getElementById('searchBox');

    const previewModal = document.getElementById('previewModal');
    const previewBody = document.getElementById('previewBody');
    const previewTitle = document.getElementById('previewTitle');
    const closePreview = document.getElementById('closePreview');

    let currentUser = null;

    // Auth handlers
    registerBtn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = passwordEl.value;
      if(!email || password.length < 6){ authMsg.textContent = 'Enter valid email and password (>=6 chars)'; authMsg.className='error'; return; }
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        authMsg.textContent = 'Registered. Please complete your profile.'; authMsg.className='success';
      }catch(e){ authMsg.textContent = 'Error: '+e.message; authMsg.className='error'; }
    });

    signInBtn.addEventListener('click', async () => {
      const email = emailEl.value.trim(); const password = passwordEl.value;
      if(!email || !password){ authMsg.textContent='Enter email and password'; authMsg.className='error'; return; }
      try{
        const cred = await signInWithEmailAndPassword(auth, email, password);
        authMsg.textContent = 'Signed in';
        authMsg.className='success';
      }catch(e){ authMsg.textContent = 'Sign in failed: '+e.message; authMsg.className='error'; }
    });

    signOutBtn.addEventListener('click', async () => { await signOut(auth); location.reload(); });

    // Save profile
    saveProfileBtn.addEventListener('click', async () => {
      if(!currentUser){ profileMsg.textContent='No user'; profileMsg.className='error'; return; }
      try{
        const udoc = doc(db, 'users', currentUser.uid);
        await setDoc(udoc, {
          name: displayNameEl.value || null,
          phone: phoneEl.value || null,
          about: aboutEl.value || null,
          updatedAt: serverTimestamp()
        }, { merge:true });
        profileMsg.textContent='Profile saved'; profileMsg.className='success';
      }catch(e){ profileMsg.textContent='Error saving profile: '+e.message; profileMsg.className='error'; }
    });

    // Auth state observer
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if(user){
        document.getElementById('authArea').style.display = 'none';
        profileArea.style.display = 'block';
        // load profile
        try{
          const udoc = await getDoc(doc(db, 'users', user.uid));
          if(udoc.exists()){
            const data = udoc.data();
            displayNameEl.value = data.name || '';
            phoneEl.value = data.phone || '';
            aboutEl.value = data.about || '';
          } else {
            displayNameEl.value = '';
            phoneEl.value = '';
            aboutEl.value = '';
          }
          // load files
          await loadFiles();
        }catch(e){
          console.error(e);
        }
      } else {
        document.getElementById('authArea').style.display = 'block';
        profileArea.style.display = 'none';
      }
    });

    // Upload file
    uploadBtn.addEventListener('click', async () => {
      if(!currentUser){ uploadMsg.textContent='Please sign in first'; uploadMsg.className='error'; return; }
      const file = fileInput.files[0];
      const name = docNameEl.value.trim() || (file ? file.name : '');
      const tag = docTagEl.value.trim() || 'Other';
      if(!file){ uploadMsg.textContent='Select file first'; uploadMsg.className='error'; return; }
      try{
        uploadMsg.textContent = 'Uploading...'; uploadMsg.className='';
        const path = `users/${currentUser.uid}/files/${Date.now()}_${file.name}`;
        const storageRef = sRef(storage, path);
        const snapshot = await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        // save metadata
        await addDoc(collection(db, 'files'), {
          owner: currentUser.uid,
          name,
          originalName: file.name,
          tag,
          size: file.size,
          contentType: file.type,
          path,
          url,
          createdAt: serverTimestamp()
        });
        uploadMsg.textContent = 'Uploaded successfully.'; uploadMsg.className='success';
        fileInput.value = ''; docNameEl.value=''; docTagEl.value='';
        loadFiles();
      }catch(e){
        uploadMsg.textContent = 'Upload error: '+e.message; uploadMsg.className='error';
      }
    });

    // Load files list
    async function loadFiles(){
      if(!currentUser) return;
      fileListEl.innerHTML = 'Loading...';
      try{
        // Query files owned by current user, newest first
        const q = query(collection(db, 'files'), where('owner','==', currentUser.uid), orderBy('createdAt','desc'));
        const snaps = await getDocs(q);
        fileListEl.innerHTML = '';
        const list = [];
        snaps.forEach(s => list.push({ id: s.id, ...s.data() }));
        // optionally filter by search
        const queryText = searchBox.value.trim().toLowerCase();
        const filtered = list.filter(it => !queryText || (it.name && it.name.toLowerCase().includes(queryText)) || (it.tag && it.tag.toLowerCase().includes(queryText)));
        if(filtered.length===0){ fileListEl.innerHTML = '<div class="note">No files yet.</div>'; return; }
        for(const f of filtered) fileListEl.appendChild(renderFileRow(f));
      }catch(e){
        console.error(e); fileListEl.innerHTML = '<div class="error">Error loading files: '+e.message+'</div>';
      }
    }

    // render file row element
    function renderFileRow(file){
      const row = document.createElement('div'); row.className='file-row';
      const meta = document.createElement('div'); meta.className='file-meta';
      const title = document.createElement('div'); title.innerHTML = `<strong>${escapeHtml(file.name||file.originalName)}</strong> <span class="tag">${escapeHtml(file.tag||'')}</span>`;
      const sub = document.createElement('div'); sub.style.fontSize='13px'; sub.style.color='var(--muted)'; sub.textContent = `${new Date((file.createdAt && file.createdAt.seconds ? file.createdAt.seconds*1000 : Date.now())).toLocaleString()} · ${(file.size/1024).toFixed(1)} KB · ${file.contentType || ''}`;
      meta.appendChild(title); meta.appendChild(sub);

      const actions = document.createElement('div'); actions.className='actions';
      const viewBtn = document.createElement('button'); viewBtn.textContent='Preview'; viewBtn.className='ghost';
      const dlBtn = document.createElement('button'); dlBtn.textContent='Download';
      const shareBtn = document.createElement('button'); shareBtn.textContent='Share'; shareBtn.className='ghost';

      viewBtn.addEventListener('click', ()=> openPreview(file));
      dlBtn.addEventListener('click', async ()=> {
        try{
          const url = file.url;
          // trigger download
          const a = document.createElement('a'); a.href = url; a.download = file.originalName || file.name; a.target='_blank';
          document.body.appendChild(a); a.click(); a.remove();
        }catch(e){ alert('Error: '+e.message); }
      });
      shareBtn.addEventListener('click', async ()=> {
        try{
          const url = file.url;
          await navigator.clipboard.writeText(url);
          alert('Share link copied to clipboard.');
        }catch(e){ alert('Could not copy: '+e.message); }
      });

      actions.appendChild(viewBtn); actions.appendChild(dlBtn); actions.appendChild(shareBtn);
      row.appendChild(meta); row.appendChild(actions);
      return row;
    }

    // preview modal
    function openPreview(file){
      previewTitle.textContent = file.name || file.originalName;
      previewBody.innerHTML = '';
      const url = file.url;
      // simple preview: images & pdf via iframe
      if(file.contentType && file.contentType.startsWith('image/')){
        const img = document.createElement('img'); img.src = url; previewBody.appendChild(img);
      } else {
        // PDF or other -> iframe
        const iframe = document.createElement('iframe'); iframe.src = url; iframe.style.border='0'; previewBody.appendChild(iframe);
      }
      previewModal.classList.add('open');
    }
    closePreview.addEventListener('click', ()=> previewModal.classList.remove('open'));
    previewModal.addEventListener('click', (e)=> { if(e.target===previewModal) previewModal.classList.remove('open') });

    // refresh & search
    refreshBtn.addEventListener('click', loadFiles);
    searchBox.addEventListener('keyup', ()=> loadFiles());

    // util
    function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // Basic note: Set secure Firebase rules and enable required billing if you expect large uploads.
    // Example minimal security rules (set in Firebase console -> Storage & Firestore rules):
    // Storage: allow read/write to only authenticated users under their folder:
    // service firebase.storage { match /b/{bucket}/o {
    //   match /users/{userId}/files/{allPaths=**} {
    //     allow read, write: if request.auth != null && request.auth.uid == userId;
    //   }
    // }}
    //
    // Firestore: only allow users to create docs with owner == request.auth.uid and read only their own docs.
    // service cloud.firestore { match /databases/{database}/documents {
    //   match /files/{fileId} {
    //     allow create: if request.auth != null && request.resource.data.owner == request.auth.uid;
    //     allow read, update, delete: if request.auth != null && resource.data.owner == request.auth.uid;
    //   }
    //   match /users/{userId} {
    //     allow read, write: if request.auth != null && request.auth.uid == userId;
    //   }
    // }}

    // drop-in: once you paste your config above this app should run in browser with no further code changes.
  </script>
</body>
</html>